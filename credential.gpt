name: azure-openai-credential

#!/usr/bin/env bash

az login --only-show-errors -o none

if [ -z "${AZURE_SUBSCRIPTION_ID}" ]; then
    subscription_id=$(gptscript -q --cache=false sys.prompt '{"message":"Please enter your Azure Subscription ID.","fields":"name"}')
    subscription_id=$(echo $subscription_id | jq -r '.name')
    export AZURE_SUBSCRIPTION_ID=$subscription_id
else
    subscription_id="${AZURE_SUBSCRIPTION_ID}"
fi

if [ -z "${GPTSCRIPT_AZURE_RESOURCE_GROUP}" ]; then
    # TODO: make this output so the user can read it
    result=$(python3 ${GPTSCRIPT_TOOL_DIR}/helpers.py)
    resource_group=$(gptscript -q --cache=false sys.prompt '{"message":"Please enter the name of the Resource Group.","fields":"name"}')
    resource_group=$(echo $resource_group | jq -r '.name')
    export GPTSCRIPT_AZURE_RESOURCE_GROUP=$resource_group
else
    resource_group="${GPTSCRIPT_AZURE_RESOURCE_GROUP}"
fi

# TODO: If we can also get the model name in here somehow, we could use that to save the endpoint and api_key
echo "{\"env\":{\"GPTSCRIPT_AZURE_RESOURCE_GROUP\":\"$resource_group\",\"AZURE_SUBSCRIPTION_ID\":\"$subscription_id\"}}"
